name: Mirror Repository

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          fetch-tags: false  # Don't fetch tags as requested
          token: ${{ secrets.MIRROR_REPO_TOKEN }}  # Use PAT instead of default GITHUB_TOKEN
          persist-credentials: true  # Keep credentials for subsequent git operations

      - name: Debug - Verify token is set
        run: |
          if [ -z "${{ secrets.MIRROR_REPO_TOKEN }}" ]; then
            echo "❌ ERROR: MIRROR_REPO_TOKEN secret is not set!"
            exit 1
          else
            echo "✅ MIRROR_REPO_TOKEN secret is configured"
            echo "Token length: ${#MIRROR_TOKEN} characters"
          fi
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up mirror remote
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          # Add mirror repository as remote with PAT authentication
          git remote add mirror https://${MIRROR_TOKEN}@github.com/ADHERmx/lima-metal-limpieza-mirror.git

          echo "✅ Mirror remote configured"
          git remote -v

      - name: Push all branches to mirror
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_REPO_TOKEN }}
        run: |
          # Push all refs from origin to mirror
          # Using refspec to push all branches directly without needing local tracking branches
          git push mirror 'refs/remotes/origin/*:refs/heads/*' --force

          echo "✅ Successfully mirrored all branches to ADHERmx/lima-metal-limpieza-mirror"
          echo ""
          echo "Branches synced:"
          git branch -r | grep 'origin/' | grep -v 'origin/HEAD' | sed 's/origin\///' | sed 's/^/  - /'

      - name: Mirror summary
        run: |
          echo "Repository mirroring complete!"
          echo "Source: Acabados-Adher-SA-de-CV/lima-metal-limpieza"
          echo "Mirror: ADHERmx/lima-metal-limpieza-mirror"
          echo "Branches synced:"
          git branch -r | grep 'origin/' | sed 's/origin\///' | sed 's/^/  - /'
